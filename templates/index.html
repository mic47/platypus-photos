 <!DOCTYPE html>
<html lang='en'>
<head>
  <meta charset="UTF-8">
  <title>
Gallery
  </title>
<link rel="stylesheet" href="css/style.css">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js/dist/chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<script src="js/main.js"></script> 
<script>
var ___state = null;
function update_dir(data) {
  ___state.update_url({"directory": data});
}
function update_url(data) {
  ___state.update_url(data);
}
function update_url_add_tag(tag) {
  const old_tag = ___state.get_url()["tag"];
  if (old_tag === undefined || old_tag === null) {
    ___state.update_url({"tag": tag});
  } else {
    ___state.update_url({"tag": `${old_tag},${tag}`});
  }
}

function init_fun() {
    if (___state !== null) {
      throw new Error('State is already initialized!');
    }

    // Set parameters
    const bounds = {% if bounds %}[[{{bounds.lat[0]}}, {{bounds.lon[0]}}],[{{bounds.lat[1]}}, {{bounds.lon[1]}}]]{% else %}null{% endif %};
    const page = {{ input.page }};
    const oi = {% if oi %}{{oi}}{% else %}null{% endif %};
    const url_parameters_fields = {{ url_parameters_fields | safe }};

    // Initialize all components
    ___state = new AppState({})
    const url_sync = new UrlSync(url_parameters_fields);
    const gallery = new Gallery("GalleryImages", page, oi);
    const map = new PhotoMap("map", bounds, () => ___state.get_url());
    const dates = new Dates("DateChart", (x) => {___state.update_url(x);});
    const directories = new Directories("Directories");
    const aggregate_info = new AggregateInfo("AggregateInfo");
    ___state.register_hook((url_params) => {
        url_sync.update(url_params);
        gallery.update_page(0, null);
        gallery.fetch(url_params);
        aggregate_info.fetch(url_params);

        dates.fetch(url_params);

        directories.fetch(url_params);

        map.update_markers(url_params, true);
    })

    // Set initial url, redraw everything
    ___state.replace_url(url_sync.get_url());
}
</script>
</head>
<body onload="init_fun()">

<div>
  <form id="input">
    <label for="ftag">Tag:</label><input type="text" id="ftag" name="tag" value="{{input.tag}}"><br>
    <label for="fcls">Text:</label><input type="text" id="fcls" name="cls" value="{{input.cls}}"><br>
    <label for="faddr">Address:</label><input type="text" id="faddr" name="addr" value="{{input.addr}}"><br>
    <label for="fdatefrom">Since</label><input type="date" id="fdatefrom" name="datefrom" value="{{input.datefrom}}" />
    <label for="fdateto">Until</label><input type="date" id="fdateto" name="dateto" value="{{input.dateto}}" /><br/>
    <label for="fdir">Directory:</label><input type="text" id="fdir" name="directory" value="{{input.directory}}"><br>
    <label for="boundary">Boundary:</label><input type="text" id="fbnd" name="bnd" value=""><br>
    <input type="submit" value="Submit">
    <input type="reset"> 
  </form>
</div>
<div id="AggregateInfo"></div>

<div id="map"></div>
<div class="date_chart"><canvas id="DateChart"></canvas></div>
<div class="directories" id="Directories"></div>
<div id="GalleryImages"></div>
</body>
</html>
