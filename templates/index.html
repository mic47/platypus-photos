 <!DOCTYPE html>
<html lang='en'>
<head>
  <meta charset="UTF-8">
  <title>
Gallery
  </title>
<style>
body {
  font-family: monospace;
}
.popup {
  max-width: 5em;
  max-height: 5em;
}
.gallery_item {
  float: left;
  width: 15em;
  height: 25em;
  background-color: #0000BB33;
  margin: 0.5em;
  border: 1px solid #fff;
  text-align: center;
}
div.gallery_item:hover {
  border: 1px solid #777;
}
.gallery_container {
  display: flex;
  width: 15em;
  height: 15em;
  justify-content: center;

}
.overlay .gallery_container {
  display: flex;
  justify-content: center;
  width: initial;
  height: initial;
  max-height: 90%;

}
.gallery_item_nav{
  display: none;
}
.overlay .gallery_item_nav {
  display: block;
}
.gallery_image {
  object-fit: contain;
  max-width: 15em;
  max-height: 15em;
}
.overlay .gallery_image {
  object-fit: contain;
  max-width: 100%;
  max-height: 100%;
}
.overlay {
  position: fixed;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background: #ffffffDD;
}

.tag a {
  color: black;
  text-decoration: none;
}
.tag {
  background-color: #00BB0033;
  border-radius: 1em;
  padding: 0.1em;
  margin: 0.2em;
}
.location {
  background-color: #BB000033;
  border-radius: 1em;
  padding: 0.1em;
  margin: 0.2em;
}
.location a {
  color: black;
  text-decoration: none;
}
.dir {
  background-color: #00BBBB33;
  border-radius: 1em;
  padding: 0.1em;
  margin: 0.2em;
}
.date{
  background-color: #BBBB0033;
  border-radius: 1em;
  padding: 0.1em;
  margin: 0.2em;
}
.date a {
  color: black;
  text-decoration: none;
}
#map { height: 180px; }
</style>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
  crossorigin=""/>
 <!-- Make sure you put this AFTER Leaflet's CSS -->
 <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
   integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
   crossorigin=""></script>
<script>
function changeState(index) {
  var url = new URL(window.location.href);
  if (index == null) {
    url.searchParams.delete("oi");
  } else {
    url.searchParams.set("oi", index);
  }
  if (window.history.replaceState) {
    window.history.replaceState(window.history.state, "", url.href);
  }
}
function overlay(element, index) {
  element.parentElement.classList.add('overlay');
  changeState(index);
}
function overlay_close(element) {
  element.parentElement.parentElement.classList.remove('overlay');
  changeState(null);
}
function overlay_prev(element, index) {
  element.parentElement.parentElement.previousElementSibling.classList.add('overlay');
  element.parentElement.parentElement.classList.remove('overlay');
  changeState(index - 1);
}
function overlay_next(element, index) {
  element.parentElement.parentElement.nextElementSibling.classList.add('overlay');
  element.parentElement.parentElement.classList.remove('overlay');
  changeState(index + 1);
}
function update_markers(map, existing_markers) {
    function inner(e) {
        console.log('event', e);
        var bounds = map.getBounds();
                console.log(bounds);
        var nw = bounds.getNorthWest();
        var se = bounds.getSouthEast();
                console.log(nw, se);
        fetch("/api/location_clusters", {
          method: "POST",
          body: JSON.stringify({
            "tl": {
              "latitude": nw.lat,
              "longitude": nw.lng,
            },
            "br": {
              "latitude": se.lat,
              "longitude": se.lng,
            },
            url: {{location_url_json | safe}},
          }),
          headers: {
            "Content-type": "application/json; charset=UTF-8"
          }
        })
          .then((response) => response.json())
          .then((clusters) => {
            console.log(clusters);
            var new_markers = [];
            for (var i = 0; i < clusters.length; i++) {
                var cluster = clusters[i];
                var marker = L.marker([cluster.position.latitude, cluster.position.longitude]).addTo(map);
                marker.bindPopup([
                    cluster.example_classification,
                    "@ ",
                    cluster.address_name,
                    ", ",
                    cluster.address_country,
                    " (",
                    cluster.size,
                    ")<br/><img src='/img?hsh=",
                    cluster.example_path_hash,
                    "' class='popup'>"
                ].join(''));
                new_markers.push(marker);
            }
            existing_markers.forEach((m) => m.remove());
            existing_markers.length = 0;
            existing_markers.push(...new_markers);
          });
    };
    return inner

}
function init_fun() {
  var map = L.map('map').setView([51.505, -0.09], 13);
        // Events: load, zoomend, moveend, resizej
  var existing_markers = [];
  map.on('load', update_markers(map, existing_markers));
  map.on('zoomend', update_markers(map, existing_markers));
  map.on('moveend', update_markers(map, existing_markers));
  map.on('resize', update_markers(map, existing_markers));

  L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
  }).addTo(map);
  {% if bounds %}
  map.fitBounds([
    [{{bounds.lat[0]}}, {{bounds.lon[0]}}],
    [{{bounds.lat[1]}}, {{bounds.lon[1]}}],
  ]);
  {% endif %}
}
</script>

</head>
<body onload="init_fun()">

<div>
  <form>
    <label for="ftag">Tag:</label><input type="text" id="ftag" name="tag" value="{{input.tag}}"><br>
    <label for="fcls">Text:</label><input type="text" id="fcls" name="cls" value="{{input.cls}}"><br>
    <label for="faddr">Address:</label><input type="text" id="faddr" name="addr" value="{{input.addr}}"><br>
    <label for="fdatefrom">Since</label><input type="date" id="fdatefrom" name="datefrom" value="{{input.datefrom}}" />
    <label for="fdateto">Until</label><input type="date" id="fdateto" name="dateto" value="{{input.dateto}}" /><br/>
    <label for="fdir">Address:</label><input type="text" id="fdir" name="dir" value="{{input.dir}}"><br>
    <input type="submit" value="Submit">
    <input type="reset"> 
  </form>
</div>
<div>
  Found {{ total }} matches. <br>
  Top tags: 
  {% for tag in top.tag %}
    <a href="{{tag[2]}}">{{tag[0]}} ({{tag[1]}})</a>
  {% endfor %} <br/>
  Top texts: 
  {% for t in top.cls %}
    <a href="{{t[2]}}">{{t[0]}} ({{t[1]}})</a>
  {% endfor %} <br/>
  Top locs: 
  {% for t in top.addr %}
    <a href="{{t[2]}}">{{t[0]}} ({{t[1]}})</a>
  {% endfor %} <br/>
  <div id="map"></div>
  {% if urls.prev %}<a href="{{urls.prev}}">{% endif %}Prev Page{% if urls.prev %}</a>{% endif %}
  {% if urls.next %}<a href="{{urls.next}}">{% endif %}Next Page{% if urls.next %}</a>{% endif %}
</div>
<div>

{% for image in images %}
  {% if loop.index0 == oi %}
  <div class="gallery_item overlay">
  {% else %}
  <div class="gallery_item">
  {% endif %}
    <div class="gallery_item_nav">
        {% if loop.index0 == 0 %}
        {% if urls.prev_overlay %}<a href="{{urls.prev_overlay}}">prev</a>{% else %} prev {% endif %}
        {% else %}
        <a href="#" onclick="overlay_prev(this, {{ loop.index0 }})">prev</a>
        {% endif %}
        <a href="#" onclick="overlay_close(this)">close</a>
        {% if loop.index == images|length %}
        {% if urls.next_overlay %}<a href="{{urls.next_overlay}}">next</a>{% else %} next {% endif %}
        {% else %}
        <a href="#" onclick="overlay_next(this, {{ loop.index0 }})">next</a>
        {% endif %}
    </div>
    <div class="gallery_container" onclick="overlay(this, {{ loop.index0 }})">
    <img src="/img?hsh={{image.hsh}}" class="gallery_image"/>
    </div>
    {{ image.classifications}} <br/>
    {% for tag in image.tags %}
    <span class="tag"><a href="{{tag[2]}}">{{tag[1]}}{{tag[0]}}</a></span>
    {% endfor %}

    {% for a in image.addrs %}
    <span class="location"><a href="{{a.url}}">{{ a.address }}</a></span>
    {% endfor %}
    {% if image.date.date %}
    <span class="date"><a href="{{image.date.url}}">{{image.date.date}}</a></span>
    {% endif %}
    <span class="dir"><a href="{{image.dir_url}}">{{image.dir}}</a></span>
  </div>
{% endfor %}
</div>
<br>
<div style="float: left; background: #CCCCCC; height: 10em;">
  {% if urls.prev %}<a href="{{urls.prev}}">{% endif %}Prev Page{% if urls.prev %}</a>{% endif %}
  {% if urls.next %}<a href="{{urls.next}}">{% endif %}Next Page{% if urls.next %}</a>{% endif %}
</div>
</body>
</html>
